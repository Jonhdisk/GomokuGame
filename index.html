<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" />
    
    <title>ü§®Gomoku Game</title>
 
</head>
<body>
    <div class="header">
        <h1>Gomoku Game</h1>
        <p>‡πÄ‡∏Å‡∏°‡πÇ‡∏Å‡∏∞‡πÇ‡∏°‡∏∞‡∏Ñ‡∏∏‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡πÄ‡∏£‡∏µ‡∏¢‡∏á 5 ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏∞!</p>
    </div>

    <div class="game-container">
        <div class="controls">
            <div class="control-group">
                <label for="boardSize">‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô:</label>
                <select id="boardSize">
                    <option value="15">15x15 (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
                    <option value="19">19x19 (‡πÉ‡∏´‡∏ç‡πà)</option>
                    <option value="13">13x13 (‡πÄ‡∏•‡πá‡∏Å)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="gameMode">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°:</label>
                <select id="gameMode">
                    <option value="local">‡πÄ‡∏•‡πà‡∏ô 2 ‡∏Ñ‡∏ô (Local)</option>
                    <option value="ai">‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö AI</option>
                    <option value="online">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                </select>
            </div>
            
            <button id="newGame">‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            <button id="showRules">‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</button>
        </div>

        <div class="status" id="gameStatus">
            <div>‚ö´ Black play before</div>
        </div>

        <div class="game-board" id="gameBoard"></div>

        <div class="online-section" id="onlineSection" style="display: none;">
            <h3>‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
            <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
            <div class="room-controls">
                <input type="text" id="roomId" class="room-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)">
                <button id="createRoom">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
                <button id="joinRoom">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
            </div>
            <div id="roomInfo" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô -->
    <div class="modal" id="rulesModal">
        <div class="modal-content">
            <h2>‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô Gomoku</h2>
            <div class="rules">
                <ul>
                    <li><strong>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</strong> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡∏°‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 5 ‡∏ï‡∏±‡∏ß‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á, ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡∏ó‡πÅ‡∏¢‡∏á)</li>
                    <li><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô:</strong> ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏Å</li>
                    <li><strong>‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞:</strong> ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ 5 ‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</li>
                    <li><strong>‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå:</strong> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏° 2 ‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°</li>
                    <li><strong>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå:</strong> ‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô</li>
                </ul>
            </div>
            <button onclick="closeRulesModal()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
    </div>

    <script>
        class GomokuGame {
            constructor() {
                this.boardSize = 15;
                this.board = [];
                this.currentPlayer = 1; // 1 = black/red, 2 = white/blue
                this.gameMode = 'local';
                this.gameOver = false;
                this.winningCells = [];
                this.isOnline = false;
                this.roomId = null;
                this.playerId = null;
                this.playerNumber = null;
                this.socket = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.initializeBoard();
            }

            initializeElements() {
                this.boardElement = document.getElementById('gameBoard');
                this.statusElement = document.getElementById('gameStatus');
                this.boardSizeSelect = document.getElementById('boardSize');
                this.gameModeSelect = document.getElementById('gameMode');
                this.onlineSection = document.getElementById('onlineSection');
                this.roomInput = document.getElementById('roomId');
                this.roomInfo = document.getElementById('roomInfo');
            }

            setupEventListeners() {
                document.getElementById('newGame').addEventListener('click', () => this.newGame());
                document.getElementById('showRules').addEventListener('click', () => this.showRules());
                this.boardSizeSelect.addEventListener('change', (e) => {
                    this.boardSize = parseInt(e.target.value);
                    this.newGame();
                });
                this.gameModeSelect.addEventListener('change', (e) => {
                    this.gameMode = e.target.value;
                    this.toggleOnlineSection();
                    this.newGame();
                });
                document.getElementById('createRoom').addEventListener('click', () => this.createRoom());
                document.getElementById('joinRoom').addEventListener('click', () => this.joinRoom());
            }

            toggleOnlineSection() {
                if (this.gameMode === 'online') {
                    this.onlineSection.style.display = 'block';
                } else {
                    this.onlineSection.style.display = 'none';
                    if (this.socket) {
                        this.socket.close();
                        this.socket = null;
                    }
                }
            }

            initializeBoard() {
                this.board = Array(this.boardSize).fill().map(() => Array(this.boardSize).fill(0));
                this.boardElement.style.gridTemplateColumns = `repeat(${this.boardSize}, 1fr)`;
                this.boardElement.innerHTML = '';
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î cell ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                const maxBoardSize = Math.min(window.innerWidth * 0.8, window.innerHeight * 0.6);
                const cellSize = Math.floor(maxBoardSize / this.boardSize);
                const minCellSize = 20;
                const finalCellSize = Math.max(cellSize, minCellSize);
                
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        cell.style.width = `${finalCellSize}px`;
                        cell.style.height = `${finalCellSize}px`;
                        cell.addEventListener('click', () => this.makeMove(i, j));
                        this.boardElement.appendChild(cell);
                    }
                }
            }

            newGame() {
                this.gameOver = false;
                this.currentPlayer = 1;
                this.winningCells = [];
                this.updateStatus('‚ö´ Black play before');
                this.initializeBoard();
                
                if (this.isOnline && this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: 'newGame',
                        roomId: this.roomId
                    }));
                }
            }

            makeMove(row, col) {
                if (this.gameOver || this.board[row][col] !== 0) return;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                if (this.isOnline) {
                    if (!this.socket || this.socket.readyState !== WebSocket.OPEN) {
                        this.updateStatus('‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
                        return;
                    }
                    if (this.playerNumber !== this.currentPlayer) {
                        this.updateStatus('‚è≥ ‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...');
                        return;
                    }
                }

                this.board[row][col] = this.currentPlayer;
                this.updateBoard();
                
                if (this.checkWin(row, col)) {
                    this.gameOver = true;
                    const playerName = this.currentPlayer === 1 ? 'Black' : 'White';
                    this.updateStatus(`üéâ Player${playerName}Victory!`);
                    this.highlightWinningCells();
                    
                    if (this.isOnline && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: 'gameOver',
                            roomId: this.roomId,
                            winner: this.currentPlayer
                        }));
                    }
                    return;
                }
                
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length === 0) {
                    this.gameOver = true;
                    this.updateStatus('ü§ù Draw!');
                    return;
                }

                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                if (this.isOnline && this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: 'move',
                        roomId: this.roomId,
                        row: row,
                        col: col,
                        player: this.currentPlayer
                    }));
                }

                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                
                if (this.gameMode === 'ai' && this.currentPlayer === 2 && !this.gameOver) {
                    setTimeout(() => this.makeAIMove(), 500);
                } else if (!this.isOnline) {
                    const playerName = this.currentPlayer === 1 ? 'Black' : 'White';
                    this.updateStatus(`${this.currentPlayer === 1 ? '‚ö´' : '‚ö™'} Turn${playerName}`);
                }
            }

            makeAIMove() {
                if (this.gameOver) return;
                
                const move = this.getBestMove();
                if (move) {
                    this.makeMove(move.row, move.col);
                }
            }

            getBestMove() {
                // AI Strategy: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞ -> ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ -> ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ
                
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ AI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        if (this.board[i][j] === 0) {
                            this.board[i][j] = 2;
                            if (this.checkWin(i, j)) {
                                this.board[i][j] = 0;
                                return { row: i, col: j };
                            }
                            this.board[i][j] = 0;
                        }
                    }
                }
                
                // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏´‡∏°
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        if (this.board[i][j] === 0) {
                            this.board[i][j] = 1;
                            if (this.checkWin(i, j)) {
                                this.board[i][j] = 0;
                                return { row: i, col: j };
                            }
                            this.board[i][j] = 0;
                        }
                    }
                }
                
                // 3. ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                const emptyCells = this.getEmptyCells();
                let bestScore = -Infinity;
                let bestMove = null;
                
                for (const cell of emptyCells) {
                    const score = this.evaluatePosition(cell.row, cell.col, 2);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMove = cell;
                    }
                }
                
                return bestMove || emptyCells[Math.floor(Math.random() * emptyCells.length)];
            }

            evaluatePosition(row, col, player) {
                let score = 0;
                const directions = [[0,1], [1,0], [1,1], [1,-1]];
                
                for (const [dr, dc] of directions) {
                    let count = 1;
                    let blocked = 0;
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ö‡∏ß‡∏Å
                    let r = row + dr, c = col + dc;
                    while (r >= 0 && r < this.boardSize && c >= 0 && c < this.boardSize) {
                        if (this.board[r][c] === player) {
                            count++;
                        } else if (this.board[r][c] === 0) {
                            break;
                        } else {
                            blocked++;
                            break;
                        }
                        r += dr;
                        c += dc;
                    }
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏ö
                    r = row - dr;
                    c = col - dc;
                    while (r >= 0 && r < this.boardSize && c >= 0 && c < this.boardSize) {
                        if (this.board[r][c] === player) {
                            count++;
                        } else if (this.board[r][c] === 0) {
                            break;
                        } else {
                            blocked++;
                            break;
                        }
                        r -= dr;
                        c -= dc;
                    }
                    
                    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
                    if (blocked < 2) {
                        switch (count) {
                            case 2: score += 10; break;
                            case 3: score += 100; break;
                            case 4: score += 1000; break;
                            case 5: score += 10000; break;
                        }
                    }
                }
                
                // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
                const centerDistance = Math.abs(row - this.boardSize/2) + Math.abs(col - this.boardSize/2);
                score += Math.max(0, 10 - centerDistance);
                
                return score;
            }

            getEmptyCells() {
                const empty = [];
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        if (this.board[i][j] === 0) {
                            empty.push({ row: i, col: j });
                        }
                    }
                }
                return empty;
            }

            checkWin(row, col) {
                const player = this.board[row][col];
                const directions = [[0,1], [1,0], [1,1], [1,-1]];
                
                for (const [dr, dc] of directions) {
                    let count = 1;
                    const winCells = [[row, col]];
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ö‡∏ß‡∏Å
                    let r = row + dr, c = col + dc;
                    while (r >= 0 && r < this.boardSize && c >= 0 && c < this.boardSize && 
                           this.board[r][c] === player) {
                        count++;
                        winCells.push([r, c]);
                        r += dr;
                        c += dc;
                    }
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏ö
                    r = row - dr;
                    c = col - dc;
                    while (r >= 0 && r < this.boardSize && c >= 0 && c < this.boardSize && 
                           this.board[r][c] === player) {
                        count++;
                        winCells.unshift([r, c]);
                        r -= dr;
                        c -= dc;
                    }
                    
                    if (count >= 5) {
                        this.winningCells = winCells;
                        return true;
                    }
                }
                
                return false;
            }

            highlightWinningCells() {
                for (const [row, col] of this.winningCells) {
                    const cell = this.boardElement.children[row * this.boardSize + col];
                    cell.classList.add('winning-line');
                }
            }

            updateBoard() {
                for (let i = 0; i < this.boardSize; i++) {
                    for (let j = 0; j < this.boardSize; j++) {
                        const cell = this.boardElement.children[i * this.boardSize + j];
                        cell.className = 'cell';
                        
                        if (this.board[i][j] === 1) {
                            cell.classList.add('black');
                        } else if (this.board[i][j] === 2) {
                            cell.classList.add('white');
                        }
                    }
                }
            }

            updateStatus(message) {
                this.statusElement.innerHTML = `<div>${message}</div>`;
            }

            showRules() {
                document.getElementById('rulesModal').style.display = 'flex';
            }

            // Online Multiplayer Functions
            createRoom() {
                const customRoomId = this.roomInput.value.trim();
                const roomId = customRoomId || this.generateRoomId();
                this.connectWebSocket(roomId, true);
            }

            joinRoom() {
                const roomId = this.roomInput.value.trim();
                if (!roomId) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á');
                    return;
                }
                this.connectWebSocket(roomId, false);
            }

            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            connectWebSocket(roomId, isCreator) {
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
                this.startLocalMultiplayer(roomId);
            }

            startLocalMultiplayer(roomId) {
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢ localStorage ‡πÅ‡∏•‡∏∞ polling
                this.roomKey = `gomoku_room_${roomId}`;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
                const roomData = JSON.parse(localStorage.getItem(this.roomKey) || '{}');
                
                if (!roomData.players) {
                    roomData.players = [];
                    roomData.board = Array(this.boardSize).fill().map(() => Array(this.boardSize).fill(0));
                    roomData.currentPlayer = 1;
                    roomData.gameOver = false;
                }
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á
                const existingPlayer = roomData.players.find(p => p.id === this.playerId);
                if (!existingPlayer) {
                    roomData.players.push({
                        id: this.playerId,
                        number: roomData.players.length + 1,
                        joinedAt: Date.now()
                    });
                }
                
                localStorage.setItem(this.roomKey, JSON.stringify(roomData));
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                this.startPolling();
            }

            startPolling() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
                
                this.pollingInterval = setInterval(() => {
                    this.checkForUpdates();
                }, 1000);
            }

            checkForUpdates() {
                const roomData = JSON.parse(localStorage.getItem(this.roomKey) || '{}');
                
                if (!roomData.players) return;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
                if (roomData.players.length === 2) {
                    // ‡πÄ‡∏Å‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°
                    if (this.roomInfo.innerHTML.includes('Waiting for player')) {
                        this.roomInfo.innerHTML = `
                            <div style="color: #4CAF50; font-weight: bold;">Full player</div>
                            <div>‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: <strong>${this.roomId}</strong></div>
                            <div>‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà ${this.playerNumber} (${this.playerNumber === 1 ? '‡∏™‡∏µ‡πÅ‡∏î‡∏á' : '‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß'})</div>
                        `;
                        this.updateStatus('üéÆ GameStart');
                    }
                    
                    // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°
                    this.syncGameState(roomData);
                }
            }

            syncGameState(roomData) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const boardChanged = JSON.stringify(this.board) !== JSON.stringify(roomData.board);
                
                if (boardChanged) {
                    this.board = roomData.board;
                    this.currentPlayer = roomData.currentPlayer;
                    this.gameOver = roomData.gameOver;
                    this.updateBoard();
                    
                    if (this.gameOver) {
                        const winner = roomData.winner;
                        const playerName = winner === 1 ? 'Black' : 'White';
                        this.updateStatus(`üéâ Player${playerName}Victory!`);
                        this.winningCells = roomData.winningCells || [];
                        this.highlightWinningCells();
                    } else {
                        const playerName = this.currentPlayer === 1 ? 'Black' : 'White';
                        if (this.currentPlayer === this.playerNumber) {
                            this.updateStatus(`${this.currentPlayer === 1 ? '‚ö´' : '‚ö™'} Turn (${playerName})`);
                        } else {
                            this.updateStatus(`${this.currentPlayer === 1 ? '‚ö´' : '‚ö™'} Waiting${playerName}Play...`);
                        }
                    }
                }
            }

            // Override makeMove ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            makeMoveOnline(row, col) {
                if (this.gameOver || this.board[row][col] !== 0) return;
                
                if (this.playerNumber !== this.currentPlayer) {
                    this.updateStatus('‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                    return;
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏°‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                this.board[row][col] = this.currentPlayer;
                this.updateBoard();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞
                if (this.checkWin(row, col)) {
                    this.gameOver = true;
                    const playerName = this.currentPlayer === 1 ? 'Black' : 'White';
                    this.updateStatus(`Victory! (${playerName})`);
                    this.highlightWinningCells();
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage
                const roomData = JSON.parse(localStorage.getItem(this.roomKey) || '{}');
                roomData.board = this.board;
                roomData.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                roomData.gameOver = this.gameOver;
                
                if (this.gameOver) {
                    roomData.winner = this.currentPlayer;
                    roomData.winningCells = this.winningCells;
                } else {
                    this.currentPlayer = roomData.currentPlayer;
                }
                
                localStorage.setItem(this.roomKey, JSON.stringify(roomData));
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏°‡∏≠
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length === 0 && !this.gameOver) {
                    this.gameOver = true;
                    roomData.gameOver = true;
                    roomData.winner = 0; // ‡πÄ‡∏™‡∏°‡∏≠
                    localStorage.setItem(this.roomKey, JSON.stringify(roomData));
                    this.updateStatus('ü§ù Draw!');
                }
            }

            // Override makeMove ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            makeMove(row, col) {
                if (this.isOnline) {
                    this.makeMoveOnline(row, col);
                } else {
                    this.makeMoveLocal(row, col);
                }
            }

            makeMoveLocal(row, col) {
                if (this.gameOver || this.board[row][col] !== 0) return;

                this.board[row][col] = this.currentPlayer;
                this.updateBoard();
                
                if (this.checkWin(row, col)) {
                    this.gameOver = true;
                    const playerName = this.currentPlayer === 1 ? 'Black' : 'White';
                    this.updateStatus(`üéâ Player${playerName}Victory!`);
                    this.highlightWinningCells();
                    return;
                }
                
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length === 0) {
                    this.gameOver = true;
                    this.updateStatus('ü§ù ‡πÄ‡∏™‡∏°‡∏≠!');
                    return;
                }

                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                
                if (this.gameMode === 'ai' && this.currentPlayer === 2 && !this.gameOver) {
                    setTimeout(() => this.makeAIMove(), 500);
                } else {
                    const playerName = this.currentPlayer === 1 ? 'Black' : 'White';
                    this.updateStatus(`${this.currentPlayer === 1 ? '‚ö´' : '‚ö™'} Turn${playerName}`);
                }
            }

            // Override newGame ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            newGame() {
                this.gameOver = false;
                this.currentPlayer = 1;
                this.winningCells = [];
                this.updateStatus('‚ö´ Black Start');
                this.initializeBoard();
                
                if (this.isOnline && this.roomKey) {
                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                    const roomData = JSON.parse(localStorage.getItem(this.roomKey) || '{}');
                    roomData.board = Array(this.boardSize).fill().map(() => Array(this.boardSize).fill(0));
                    roomData.currentPlayer = 1;
                    roomData.gameOver = false;
                    roomData.winner = null;
                    roomData.winningCells = [];
                    localStorage.setItem(this.roomKey, JSON.stringify(roomData));
                }
            }

            // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            destroy() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
                
                if (this.isOnline && this.roomKey) {
                    // ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
                    const roomData = JSON.parse(localStorage.getItem(this.roomKey) || '{}');
                    if (roomData.players) {
                        roomData.players = roomData.players.filter(p => p.id !== this.playerId);
                        if (roomData.players.length === 0) {
                            localStorage.removeItem(this.roomKey);
                        } else {
                            localStorage.setItem(this.roomKey, JSON.stringify(roomData));
                        }
                    }
                }
            }
        }

        // ‡∏õ‡∏¥‡∏î Modal ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
        function closeRulesModal() {
            document.getElementById('rulesModal').style.display = 'none';
        }

        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
        window.onclick = function(event) {
            const modal = document.getElementById('rulesModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
        const game = new GomokuGame();

        // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        window.addEventListener('beforeunload', () => {
            game.destroy();
        });

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Å‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        window.addEventListener('resize', () => {
            game.initializeBoard();
        });
    </script>
</body>
</html> 
